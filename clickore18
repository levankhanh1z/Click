local Players = game:GetService("Players")
local ReplicatedStorage = game:GetService("ReplicatedStorage")

local maxClickDistance = 100
local stonePart = workspace.Mine.Stone

local function isPartNearPlayer(part)
    local playerPosition = Players.LocalPlayer.Character and Players.LocalPlayer.Character:FindFirstChild("HumanoidRootPart") and Players.LocalPlayer.Character.HumanoidRootPart.Position
    if playerPosition then
        local partPosition = part.Position
        local distance = (playerPosition - partPosition).Magnitude
        return distance <= maxClickDistance
    end
    return false
end

local function hasRemoteEvent(part)
    local remoteEventName = "MineEvent"  -- Thay đổi thành tên sự kiện từ xa bạn đang sử dụng
    return part:FindFirstChild(remoteEventName) ~= nil
end

local function getOrCreateRemoteEvent(part)
    local remoteEventName = "MineEvent"  -- Thay đổi thành tên sự kiện từ xa bạn đang sử dụng
    local remoteEvent = part:FindFirstChild(remoteEventName)
    
    if not remoteEvent then
        remoteEvent = Instance.new("RemoteEvent")
        remoteEvent.Name = remoteEventName
        remoteEvent.Parent = part
    end
    
    return remoteEvent
end

local function handleClickAndFireServer(part)
    if part.Name == "Stone" then
        print("Auto Clicked on Stone part!")

        if isPartNearPlayer(part) then
            local partCFrame = part.CFrame
            local clickPosition = part.Position

            local remoteEventName = "MineEvent"  -- Thay đổi thành tên sự kiện từ xa bạn đang sử dụng

            local pinglessMineEvent = ReplicatedStorage:FindFirstChild("PinglessMine")
            local mineOreEvent = ReplicatedStorage:FindFirstChild("MineOre")
            local mineEvent = getOrCreateRemoteEvent(part)

            if pinglessMineEvent then
                local args = {partCFrame, clickPosition}
                pinglessMineEvent:FireServer(unpack(args))
            else
                warn("RemoteEvent 'PinglessMine' not found.")
            end

            if mineOreEvent then
                local args = {partCFrame, clickPosition}
                mineOreEvent:FireServer(unpack(args))
            else
                warn("RemoteEvent 'MineOre' not found.")
            end

            if mineEvent then
                local args = {partCFrame, clickPosition}
                mineEvent:FireServer(unpack(args))
            else
                warn("RemoteEvent '" .. remoteEventName .. "' not found.")
            end

            -- Tìm các Part gần đó và thực hiện sự kiện click cho chúng
            for _, nearbyPart in pairs(workspace.Mine:GetPartsInRegion(part.Position, Vector3.new(maxClickDistance, maxClickDistance, maxClickDistance), nil)) do
                if nearbyPart:IsA("Part") and nearbyPart.Name ~= "Stone" and hasRemoteEvent(nearbyPart) then
                    print("Auto Clicked on Nearby Part:", nearbyPart.Name)
                    local nearbyPartCFrame = nearbyPart.CFrame
                    local nearbyClickPosition = nearbyPart.Position

                    -- Thực hiện sự kiện click cho Part bên cạnh
                    local nearbyRemoteEvent = getOrCreateRemoteEvent(nearbyPart)
                    if nearbyRemoteEvent then
                        local args = {nearbyPartCFrame, nearbyClickPosition}
                        nearbyRemoteEvent:FireServer(unpack(args))
                    else
                        warn("RemoteEvent '" .. remoteEventName .. "' not found for Nearby Part.")
                    end
                end
            end
        end
    end
end

local function handleTouched(part)
    part.Touched:Connect(function(hit)
        if hit:IsA("Player") then
            print("Player touched", part.Name)
            -- Thực hiện sự kiện click khi người chơi chạm vào Part
            handleClickAndFireServer(part)
        end
    end)
end

-- Sự kiện Touched để theo dõi khi người chơi chạm vào Stone
handleTouched(stonePart)

-- Sự kiện Touched để theo dõi khi người chơi chạm vào các Part bên cạnh
for _, nearbyPart in pairs(workspace.Mine:GetPartsInRegion(stonePart.Position, Vector3.new(maxClickDistance, maxClickDistance, maxClickDistance), nil)) do
    if nearbyPart:IsA("Part") and nearbyPart.Name ~= "Stone" then
        handleTouched(nearbyPart)
    end
end
